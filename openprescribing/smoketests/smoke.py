import csv
import StringIO
import requests
import unittest

'''
Run smoke tests against live site. 35 separate tests to run.
Spending BY: one practice, multiple practices, one CCG,
multiple CCGs, all
Spending ON: one presentation, multiple presentations, one chemical,
multiple chemicals, one section, multiple sections, all
The expected numbers are generated from smoke.sh
'''


class SmokeTestBase(unittest.TestCase):

    DOMAIN = 'https://openprescribing.net'
    NUM_RESULTS = 62  # Should equal number of months since Aug 2010.
    NUM_RESULTS_CCG = 30  # Should equal number of months since Apr 2013.


class TestSmokeTestSpendingByEveryone(SmokeTestBase):

    def test_presentation_by_all(self):
        url = '%s/api/1.0/spending/?format=csv&' % self.DOMAIN
        url += 'code=0501013B0AAAAAA'
        print url
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)
        self.assertEqual(len(all_rows), self.NUM_RESULTS)

        expected = {
            'cost': ['173145.07', '228780.7', '207137.63', '205640.63',
                     '316925.39', '247323.08', '180616.86', '206444.12',
                     '141434.65', '122800.11', '125620.83', '118777.89',
                     '118020.47', '130835.43', '125841.77', '138486.42',
                     '158486.85', '173513.96', '164191.32', '158338.12',
                     '131714.06', '144724.09', '114181.88', '171930.9',
                     '144586.73', '138152.94', '149221.97', '139476.22',
                     '172271.7', '203581.4', '162139.09', '154016.38',
                     '176507.5', '151758.62', '131727.14', '134678.5',
                     '114468.59', '141902.17', '150113.53', '140274.34',
                     '172423.18', '177029.2', '147735.35', '148171.52',
                     '124204.42', '109308.23', '98182.55', '92726.89',
                     '78257.54', '96787.25', '112760.94', '104402.85',
                     '162214.41', '136258.51', '103858.93', '105283.89',
                     '79601.15', '67056.04', '64778.3399999999', '56942.49',
                     '49410.42', '56696.4'],
            'items': ['135285', '179343', '206509', '203952', '318374',
                      '246994', '179990', '205546', '157269', '134698',
                      '138143', '125593', '124433', '138858', '153877',
                      '169692', '193914', '189579', '179609', '172615',
                      '140240', '153954', '121455', '134375', '111585',
                      '108392', '151040', '141165', '176372', '178349',
                      '142975', '135271', '122785', '104976', '91230',
                      '89153', '75546', '94734', '112609', '105452',
                      '130118', '130633', '108980', '108882', '96544',
                      '83970', '75548', '69542', '58336', '73325', '81469',
                      '75573', '118616', '98160', '74280', '74828', '59537',
                      '49988', '47677', '43856', '37904', '43847']
        }
        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])

    def test_chemical_by_all(self):
        url = '%s/api/1.0/spending/?format=csv&' % self.DOMAIN
        url += 'code=0407010F0'
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)
        self.assertEqual(len(all_rows), self.NUM_RESULTS)

        expected = {
            'cost': ['6133489.35', '6595886.24', '5448794.44', '5551136.73',
                     '5837764.67', '5255731.54', '5021812.13', '5837317.5',
                     '5123377.75', '5554369.18', '5649880.6', '5385448.28',
                     '5507235.55', '5718628.68', '4763680.3', '4961449.59',
                     '5079846.8', '5245568.36', '5132817.97', '5553824.91',
                     '5224975.54', '5773668.13', '5291806.04', '7190742.14',
                     '7394035.63', '6861596.44', '6511269.1', '6424956.69',
                     '6249256.05', '6558457.36', '5890247.0', '6319251.11',
                     '6471276.3', '6728036.2', '6185170.45', '6892796.06',
                     '6695291.9', '6525265.61', '6658986.31', '6362063.89',
                     '6506565.5', '6668832.58', '5916229.32', '6448645.78',
                     '6159018.26', '6362466.3', '6109185.03', '6803242.49',
                     '6329146.77', '6704887.16', '7381763.62', '6629628.26',
                     '7417957.7', '7214341.6', '6624682.65', '7310517.54',
                     '7428270.87', '7237368.15', '7557166.49', '8451412.6',
                     '7728906.34999999', '8249131.33'],
            'items': ['1207416', '1298364', '1221403', '1244005', '1297529',
                      '1206699', '1144401', '1323870', '1170520', '1272598',
                      '1294637', '1234908', '1264490', '1311344', '1226903',
                      '1275021', '1289356', '1248388', '1217298', '1312834',
                      '1211848', '1333775', '1221137', '1267881', '1300668',
                      '1217327', '1300043', '1282008', '1235280', '1298413',
                      '1166055', '1245296', '1281474', '1328379', '1222904',
                      '1311318', '1271070', '1244981', '1324954', '1266266',
                      '1285570', '1322953', '1177393', '1279808', '1267123',
                      '1309035', '1260537', '1343435', '1248408', '1322880',
                      '1366847', '1229510', '1365661', '1312875', '1201278',
                      '1325698', '1296322', '1263928', '1319851', '1354201',
                      '1232839', '1330756']
        }
        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])

    def test_bnf_section_by_all(self):
        url = '%s/api/1.0/spending/?format=csv&' % self.DOMAIN
        url += 'code=0702'
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)
        self.assertEqual(len(all_rows), self.NUM_RESULTS)

        expected = {
            'cost': ['1048672.67', '1127042.93', '1042493.25', '1062209.98',
                     '988411.7', '973086.68', '990670.22', '1149901.88',
                     '969507.76', '1110820.48', '1195126.07', '1191993.85',
                     '1201804.51', '1237834.19', '1170580.04', '1244600.01',
                     '1185112.57', '1202255.45', '1169818.04', '1269828.99',
                     '1121678.15', '1282687.92', '1169826.44', '1288998.84',
                     '1305555.5', '1248961.94', '1352418.46', '1324359.56',
                     '1200235.32', '1300895.66', '1155940.37', '1276935.39',
                     '1333993.63', '1369838.44', '1318994.71', '1421618.25',
                     '1379556.61', '1357230.86', '1482408.79', '1414131.16',
                     '1397686.78', '1478486.17', '1354964.58', '1457538.12',
                     '1410476.74', '1496945.4', '1479184.18', '1574966.32',
                     '1459622.8', '1541425.02', '1610820.78', '1655841.78',
                     '1763329.16', '1746247.0', '1636268.47', '1801512.54',
                     '1719712.72', '1759283.05', '2024251.73', '2072863.43',
                     '1890817.83', '2021293.31'],
            'items': ['156561', '168362', '157446', '158295', '149587',
                      '151179', '149032', '171606', '145126', '162027',
                      '174998', '168762', '170364', '175202', '166402',
                      '176484', '165504', '169119', '163399', '177434',
                      '156048', '178286', '163706', '179681', '180437',
                      '172916', '186445', '180630', '160950', '177981',
                      '158564', '169470', '173728', '178547', '171468',
                      '184516', '177547', '176671', '187435', '177551',
                      '173461', '185364', '167303', '179236', '172467',
                      '181217', '181192', '191754', '175167', '188101',
                      '193605', '175423', '183440', '182327', '168461',
                      '186449', '177468', '176166', '189228', '193987',
                      '175902', '189147']
        }
        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])


class TestSmokeTestSpendingByOnePractice(SmokeTestBase):

    def test_presentation_by_one_practice(self):
        url = '%s/api/1.0/spending_by_practice/?format=csv&' % self.DOMAIN
        url += 'code=0703021Q0BBAAAA&org=A81015'  # Cerazette 75mcg.
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)

        self.assertEqual(len(all_rows), self.NUM_RESULTS)

        expected = {
            'cost': ['138.94', '128.23', '77.57', '42.82', '117.64',
                     '248.45', '90.93', '173.86', '101.58', '123.08', '120.4',
                     '145.92', '197.85', '272.74', '90.98', '69.68', '206.22',
                     '109.75', '144.75', '144.8', '139.13', '166.1', '115.02',
                     '145.13', '190.37', '112.42', '198.47', '114.5', '216.49',
                     '230.51', '158.4', '153.23', '118.48', '175.15', '136.83',
                     '166.24', '110.15', '147.84', '166.75', '139.35', '191.03',
                     '145.36', '94.09', '190.16', '118.21', '126.32', '163.56',
                     '150.81', '138.92', '153.6', '103.61', '62.03', '165.33',
                     '106.48', '99.87', '117.65', '100.59', '89.03', '112.21',
                     '94.8', '76.78', '50.64'],
            'items': ['16', '14', '12', '7', '13',
                      '24', '9', '17', '12', '12', '14',
                      '21', '18', '26', '12', '12', '19',
                      '10', '17', '18', '16', '16', '13',
                      '18', '20', '11', '20', '17', '22',
                      '20', '17', '16', '14', '15', '15',
                      '15', '12', '17', '19', '14', '18',
                      '17', '11', '20', '14', '13', '14',
                      '16', '13', '12', '10', '6', '14',
                      '11', '9', '10', '9', '10', '8',
                      '10', '6', '7']
        }

        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])

    def test_chemical_by_one_practice(self):
        url = '%s/api/1.0/spending_by_practice/?' % self.DOMAIN
        url += 'format=csv&code=0212000AA&org=A81015'  # Rosuvastatin Calcium.
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)

        self.assertEqual(len(all_rows), self.NUM_RESULTS)

        expected = {
            'cost': ['57.22', '90.47', '57.21', '49.89', '49.92',
                     '16.63', '73.96', '57.31', '57.24', '57.32', '73.94',
                     '33.28', '90.58', '49.94', '90.56', '49.94', '81.44',
                     '33.32', '33.35',  '57.41', '57.3', '40.73', '57.28',
                     '57.38', '57.31', '56.16',  '57.29', '49.89', '83.18',
                     '98.07', '57.39', '81.5', '64.74', '97.99', '57.29',
                     '98.02', '81.38', '105.44', '57.39', '105.32', '64.72',
                     '98.06', '98.02', '98.18', '98.06', '64.8', '81.4',
                     '57.45', '81.46', '105.57', '16.68', '81.3', '125.55',
                     '84.75', '84.93', '109.11', '84.91', '109.01', '84.96',
                     '108.99', '84.89', '133.12'],
            'items': ['3', '5', '3', '3', '3',
                      '1', '4', '3', '3', '3', '4',
                      '2', '5', '3', '5', '3', '4',
                      '2', '2', '3', '3', '2', '3',
                      '3', '3', '3', '3', '3', '5',
                      '5', '3', '4', '3', '5', '3',
                      '5', '4', '5', '3', '5', '3',
                      '5', '5', '5', '5', '3', '4',
                      '3', '4', '5', '1', '4', '6',
                      '4', '4', '5', '4', '5', '4',
                      '5', '4', '6']
        }
        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])

    def test_multiple_chemicals_by_one_practice(self):
        url = '%s/api/1.0/spending_by_practice/?format=csv&' % self.DOMAIN
        url += 'code=0212000B0,0212000C0,0212000M0,0212000X0,0212000Y0'
        url += '&org=C85020'  # Multiple generic statins.
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)

        self.assertEqual(len(all_rows), self.NUM_RESULTS)

        expected = {
            'cost': ['9979.53', '10289.65', '9675.42', '10249.11', '10835.87',
                     '9721.39', '9255.99', '10763.7', '9363.32', '10079.41',
                     '10457.78', '10186.81', '10481.81', '10658.54', '9891.32',
                     '11073.95', '10959.99', '9550.1', '10305.12', '11385.31',
                     '9820.74', '12811.91', '4283.13', '4285.25', '2804.97',
                     '2808.93', '2513.38', '2511.02', '2461.4', '2422.92',
                     '2225.54', '2243.14', '2458.26', '2648.84', '2269.74',
                     '2411.39', '2428.54', '2230.12', '2335.49', '2115.65',
                     '2425.06', '2274.16', '2207.01', '2322.6', '2043.0',
                     '2059.34', '1973.39', '2256.22', '2040.32', '2054.39',
                     '2316.73', '2342.52', '2042.44', '2286.73', '2527.1',
                     '2378.36', '2273.38', '2267.96', '2316.11', '2499.35',
                     '2176.26', '2259.22'],
            'items': ['1367', '1428', '1375', '1398', '1573',
                      '1316', '1260', '1527', '1343', '1366', '1468',
                      '1381', '1511', '1491', '1394', '1561', '1555',
                      '1454', '1530', '1601', '1459', '1895', '1788',
                      '1854', '1931', '1772', '1949', '1867', '1917',
                      '1901', '1759', '1813', '1886', '2002', '1742',
                      '1897', '1883', '1777', '1977', '1830', '2068',
                      '1945', '1812', '1826', '1871', '1867', '1809',
                      '2030', '1813', '1837', '1893', '1906', '1725',
                      '1908', '2028', '1992', '1938', '1869', '1967',
                      '2177', '1865', '2045']
        }
        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])

    def test_bnf_section_by_one_practice(self):
        url = '%s/api/1.0/spending_by_practice/' % self.DOMAIN
        url += '?format=csv&code=0304&org=L84077'
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)

        self.assertEqual(len(all_rows), self.NUM_RESULTS)

        expected = {
            'cost': ['103.89', '121.07', '257.2', '74.6', '112.71',
                     '99.62', '78.03', '219.45', '104.22', '130.93', '242.17',
                     '150.92', '261.08', '103.75', '48.54', '85.68', '70.13',
                     '105.4', '39.12', '122.96', '177.47', '110.2', '213.01',
                     '317.37', '180.87', '178.11', '97.58', '170.66', '200.57',
                     '77.88', '45.8', '153.94', '91.94', '178.93', '196.83',
                     '257.21', '194.35', '107.01', '304.33', '115.41', '76.98',
                     '136.66', '121.89', '85.19', '201.19', '148.67', '238.95',
                     '185.69', '152.56', '202.67', '166.08', '156.27', '82.07',
                     '69.95', '75.88', '123.5', '172.32', '166.42', '247.19',
                     '345.6', '193.43', '92.46'],
            'items': ['37', '33', '35', '37', '36',
                      '35', '30', '50', '59', '57', '70',
                      '52', '49', '41', '20', '30', '25',
                      '28', '19', '42', '54', '66', '59',
                      '68', '50', '46', '40', '44', '45',
                      '43', '34', '46', '46', '76', '68',
                      '84', '62', '38', '55', '49', '50',
                      '59', '54', '55', '73', '73', '94',
                      '98', '73', '63', '68', '54', '60',
                      '60', '62', '60', '73', '70', '93',
                      '103', '71', '62']
        }
        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])


class TestSmokeTestSpendingByCCG(SmokeTestBase):

    def test_presentation_by_one_ccg(self):
        url = '%s/api/1.0/spending_by_ccg?' % self.DOMAIN
        url += 'format=csv&code=0403030E0AAAAAA&org=10Q'
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)

        self.assertEqual(len(all_rows), self.NUM_RESULTS_CCG)

        expected = {
            'cost': ['8955.03', '9104.38', '8476.08', '10254.64',
                     '10005.36', '9558.36', '9823.32', '9551.47',
                     '9913.82', '10758.87', '9798.25', '10680.19',
                     '9366.06', '9794.72', '9575.28', '10321.55',
                     '9587.88', '9874.99', '11195.18', '10139.97',
                     '11382.04', '11729.27', '10499.37', '11774.95',
                     '11617.16', '11665.55', '12136.77', '11840.51',
                     '11166.01', '11495.47'],
            'items': ['6379', '6518', '6129', '6681', '6501',
                      '6207', '6710', '6439', '6691', '6799',
                      '6252', '6676', '6583', '6770', '6672',
                      '6949', '6470', '6741', '7142', '6490',
                      '7236', '7063', '6466', '7164', '6948',
                      '6905', '7146', '7379', '6783', '7104']
        }
        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])

    def test_chemical_by_one_ccg(self):
        url = '%s/api/1.0/spending_by_ccg?' % self.DOMAIN
        url += 'format=csv&code=0212000AA&org=10Q'
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)

        self.assertEqual(len(all_rows), self.NUM_RESULTS_CCG)

        expected = {
            'cost': ['17191.81', '20131.86', '18143.13', '19648.75',
                     '18628.06', '19572.88', '19378.02', '19497.54',
                     '20529.77', '19686.22', '18649.07', '18896.22',
                     '20061.72', '20287.16', '20300.75', '20281.96',
                     '19749.44', '20688.56', '22274.66', '19595.64',
                     '22114.7', '22351.11', '17809.11', '21830.67',
                     '19859.25', '20254.8', '21609.31', '23332.98',
                     '19554.12', '21383.46'],
            'items': ['715', '782', '726', '780', '752', '770', '784',
                      '773', '798', '783', '719', '769', '813', '805',
                      '820', '815', '783', '831', '891', '791', '914',
                      '915', '758', '881', '814', '842', '887', '972',
                      '850', '880']
        }
        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])

    def test_bnf_section_by_one_ccg(self):
        url = '%s/api/1.0/spending_by_ccg?' % self.DOMAIN
        url += 'format=csv&code=0801&org=10Q'
        r = requests.get(url)
        f = StringIO.StringIO(r.text)
        reader = csv.DictReader(f)
        all_rows = []
        for row in reader:
            all_rows.append(row)

        self.assertEqual(len(all_rows), self.NUM_RESULTS_CCG)

        expected = {
            'cost': ['5845.77', '7588.99', '6687.19', '5756.83', '7486.5',
                     '6263.94', '5680.75', '8016.47', '7025.84', '7015.16',
                     '6785.06', '5152.56', '8115.77', '6041.56', '6775.97',
                     '8249.45', '8082.88', '8477.85', '6532.61', '7360.49',
                     '8627.81', '9020.02', '5778.31', '8132.1', '7252.01',
                     '7034.92', '7700.04', '9279.48', '8110.4', '6538.47'],
            'items': ['206', '234', '226', '220', '208', '223', '220', '233',
                      '239', '217', '198', '207', '241', '251', '227', '224',
                      '242', '247', '232', '233', '230', '255', '209', '257',
                      '232', '247', '230', '270', '241', '236']
        }
        for i, row in enumerate(all_rows):
            self.assertEqual(row['actual_cost'], expected['cost'][i])
            self.assertEqual(row['items'], expected['items'][i])

if __name__ == '__main__':
    unittest.main()
